<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.cms.modules.population.mapper.EmploymentMapper">
    
    <resultMap id="EmploymentMap" type="com.example.cms.modules.population.entity.Employment">
        <id property="id" column="id"/>
        <result property="residentId" column="resident_id"/>
        <result property="residentName" column="resident_name"/>
        <result property="idCard" column="id_card"/>
        <result property="company" column="company"/>
        <result property="position" column="position"/>
        <result property="salary" column="salary"/>
        <result property="employmentStatus" column="employment_status"/>
        <result property="industry" column="industry"/>
        <result property="startDate" column="start_date"/>
        <result property="contractType" column="contract_type"/>
        <result property="notes" column="notes"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="createdBy" column="created_by"/>
    </resultMap>
    
    <sql id="Base_Column_List">
        id, resident_id, resident_name, id_card, company, position, salary, employment_status, industry, start_date, contract_type, notes, create_time, update_time, created_by
    </sql>
    
    <select id="findAll" resultMap="EmploymentMap">
        SELECT <include refid="Base_Column_List"/> FROM employment
    </select>
    
    <select id="findById" resultMap="EmploymentMap">
        SELECT <include refid="Base_Column_List"/> FROM employment WHERE id = #{id}
    </select>
    
    <select id="findByResidentId" resultMap="EmploymentMap">
        SELECT <include refid="Base_Column_List"/> FROM employment WHERE resident_id = #{residentId}
    </select>
    
    <insert id="insert">
        INSERT INTO employment(id, resident_id, resident_name, id_card, company, position, salary, employment_status, industry, start_date, contract_type, notes, create_time, update_time, created_by)
        VALUES(#{id}, #{residentId}, #{residentName}, #{idCard}, #{company}, #{position}, #{salary}, #{employmentStatus}, #{industry}, #{startDate}, #{contractType}, #{notes}, #{createTime}, #{updateTime}, #{createdBy})
    </insert>
    
    <update id="update">
        UPDATE employment SET 
            resident_id = #{residentId},
            resident_name = #{residentName},
            id_card = #{idCard},
            company = #{company},
            position = #{position},
            salary = #{salary},
            employment_status = #{employmentStatus},
            industry = #{industry},
            start_date = #{startDate},
            contract_type = #{contractType},
            notes = #{notes},
            update_time = #{updateTime}
        WHERE id = #{id}
    </update>
    
    <delete id="deleteById">
        DELETE FROM employment WHERE id = #{id}
    </delete>
    
    <select id="count" resultType="int">
        SELECT COUNT(*) FROM employment
    </select>
    
    <select id="search" resultMap="EmploymentMap">
        SELECT <include refid="Base_Column_List"/> FROM employment
        <where>
            <if test="residentName != null and residentName != ''">
                AND resident_name LIKE CONCAT('%', #{residentName}, '%')
            </if>
            <if test="companyName != null and companyName != ''">
                AND company LIKE CONCAT('%', #{companyName}, '%')
            </if>
            <if test="industry != null and industry != ''">
                AND industry LIKE CONCAT('%', #{industry}, '%')
            </if>
            <if test="employmentStatus != null and employmentStatus != ''">
                AND employment_status = #{employmentStatus}
            </if>
        </where>
    </select>
    
    <select id="searchWithPagination" resultMap="EmploymentMap">
        SELECT e.id, e.resident_id, e.resident_name, e.id_card, e.company, e.position, e.salary, e.employment_status, e.industry, e.start_date, e.contract_type, e.notes, e.create_time, e.update_time, e.created_by
        FROM employment e
        WHERE 1=1
        <if test="residentName != null and residentName != ''">
            AND e.resident_name LIKE CONCAT('%', #{residentName}, '%')
        </if>
        <if test="companyName != null and companyName != ''">
            AND e.company LIKE CONCAT('%', #{companyName}, '%')
        </if>
        <if test="industry != null and industry != ''">
            AND e.industry LIKE CONCAT('%', #{industry}, '%')
        </if>
        <if test="employmentStatus != null and employmentStatus != ''">
            AND e.employment_status = #{employmentStatus}
        </if>
        ORDER BY e.id ASC
        LIMIT #{size} OFFSET #{offset}
    </select>
    
    <select id="countBySearch" resultType="int">
        SELECT COUNT(*) FROM employment e
        WHERE 1=1
        <if test="residentName != null and residentName != ''">
            AND e.resident_name LIKE CONCAT('%', #{residentName}, '%')
        </if>
        <if test="companyName != null and companyName != ''">
            AND e.company LIKE CONCAT('%', #{companyName}, '%')
        </if>
        <if test="industry != null and industry != ''">
            AND e.industry LIKE CONCAT('%', #{industry}, '%')
        </if>
        <if test="employmentStatus != null and employmentStatus != ''">
            AND e.employment_status = #{employmentStatus}
        </if>
    </select>
    
    <select id="searchByCreatedBy" resultMap="EmploymentMap">
        SELECT e.id, e.resident_id, e.resident_name, e.id_card, e.company, e.position, e.salary, e.employment_status, e.industry, e.start_date, e.contract_type, e.notes, e.create_time, e.update_time, e.created_by
        FROM employment e
        WHERE e.created_by = #{createdBy}
        <if test="residentName != null and residentName != ''">
            AND e.resident_name LIKE CONCAT('%', #{residentName}, '%')
        </if>
        <if test="companyName != null and companyName != ''">
            AND e.company LIKE CONCAT('%', #{companyName}, '%')
        </if>
        <if test="industry != null and industry != ''">
            AND e.industry LIKE CONCAT('%', #{industry}, '%')
        </if>
        <if test="employmentStatus != null and employmentStatus != ''">
            AND e.employment_status = #{employmentStatus}
        </if>
        ORDER BY e.id ASC
        LIMIT #{size} OFFSET #{offset}
    </select>
    
    <select id="countByCreatedByAndSearch" resultType="int">
        SELECT COUNT(*) FROM employment e
        WHERE e.created_by = #{createdBy}
        <if test="residentName != null and residentName != ''">
            AND e.resident_name LIKE CONCAT('%', #{residentName}, '%')
        </if>
        <if test="companyName != null and companyName != ''">
            AND e.company LIKE CONCAT('%', #{companyName}, '%')
        </if>
        <if test="industry != null and industry != ''">
            AND e.industry LIKE CONCAT('%', #{industry}, '%')
        </if>
        <if test="employmentStatus != null and employmentStatus != ''">
            AND e.employment_status = #{employmentStatus}
        </if>
    </select>
    
    <!-- 根据管理员和创建者ID及搜索条件分页搜索就业信息 -->
    <select id="searchByAdminOrCreatedBy" resultMap="EmploymentMap">
        SELECT e.id, e.resident_id, e.resident_name, e.id_card, e.company, e.position, e.salary, e.employment_status, e.industry, e.start_date, e.contract_type, e.notes, e.create_time, e.update_time, e.created_by
        FROM employment e
        WHERE e.created_by = 1 OR e.created_by = #{createdBy}
        <if test="residentName != null and residentName != ''">
            AND e.resident_name LIKE CONCAT('%', #{residentName}, '%')
        </if>
        <if test="companyName != null and companyName != ''">
            AND e.company LIKE CONCAT('%', #{companyName}, '%')
        </if>
        <if test="industry != null and industry != ''">
            AND e.industry LIKE CONCAT('%', #{industry}, '%')
        </if>
        <if test="employmentStatus != null and employmentStatus != ''">
            AND e.employment_status = #{employmentStatus}
        </if>
        ORDER BY e.id ASC
        LIMIT #{size} OFFSET #{offset}
    </select>
    
    <!-- 根据管理员和创建者ID及搜索条件统计记录数 -->
    <select id="countByAdminOrCreatedByAndSearch" resultType="int">
        SELECT COUNT(*) FROM employment e
        WHERE e.created_by = 1 OR e.created_by = #{createdBy}
        <if test="residentName != null and residentName != ''">
            AND e.resident_name LIKE CONCAT('%', #{residentName}, '%')
        </if>
        <if test="companyName != null and companyName != ''">
            AND e.company LIKE CONCAT('%', #{companyName}, '%')
        </if>
        <if test="industry != null and industry != ''">
            AND e.industry LIKE CONCAT('%', #{industry}, '%')
        </if>
        <if test="employmentStatus != null and employmentStatus != ''">
            AND e.employment_status = #{employmentStatus}
        </if>
    </select>
    
    <!-- 获取就业表中的全局最大ID -->
    <select id="getMaxId" resultType="long">
        SELECT COALESCE(MAX(id), 0) FROM employment
    </select>
    
    <!-- 重新排序就业ID，确保ID连续 -->
    <update id="reorderIds">
        UPDATE employment e
        JOIN (
            SELECT id, @new_id := @new_id + 1 AS new_id
            FROM employment, (SELECT @new_id := 0) AS tmp
            ORDER BY id ASC
        ) e2 ON e.id = e2.id
        SET e.id = e2.new_id;
    </update>
    
    <!-- 根据居民ID列表和搜索条件分页查询就业信息 -->
    <select id="searchByResidentIdsAndSearchConditions" resultMap="EmploymentMap">
        SELECT e.id, e.resident_id, e.resident_name, e.id_card, e.company, e.position, e.salary, e.employment_status, e.industry, e.start_date, e.contract_type, e.notes, e.create_time, e.update_time, e.created_by
        FROM employment e
        WHERE e.resident_id IN
        <foreach collection="residentIds" item="residentId" open="(" separator="," close=")">
            #{residentId}
        </foreach>
        <if test="residentName != null and residentName != ''">
            AND e.resident_name LIKE CONCAT('%', #{residentName}, '%')
        </if>
        <if test="companyName != null and companyName != ''">
            AND e.company LIKE CONCAT('%', #{companyName}, '%')
        </if>
        <if test="industry != null and industry != ''">
            AND e.industry LIKE CONCAT('%', #{industry}, '%')
        </if>
        <if test="employmentStatus != null and employmentStatus != ''">
            AND e.employment_status = #{employmentStatus}
        </if>
        ORDER BY e.id ASC
        LIMIT #{size} OFFSET #{offset}
    </select>
    
    <!-- 根据居民ID列表和搜索条件统计就业信息数量 -->
    <select id="countByResidentIdsAndSearchConditions" resultType="int">
        SELECT COUNT(*) FROM employment e
        WHERE e.resident_id IN
        <foreach collection="residentIds" item="residentId" open="(" separator="," close=")">
            #{residentId}
        </foreach>
        <if test="residentName != null and residentName != ''">
            AND e.resident_name LIKE CONCAT('%', #{residentName}, '%')
        </if>
        <if test="companyName != null and companyName != ''">
            AND e.company LIKE CONCAT('%', #{companyName}, '%')
        </if>
        <if test="industry != null and industry != ''">
            AND e.industry LIKE CONCAT('%', #{industry}, '%')
        </if>
        <if test="employmentStatus != null and employmentStatus != ''">
            AND e.employment_status = #{employmentStatus}
        </if>
    </select>
    
</mapper>