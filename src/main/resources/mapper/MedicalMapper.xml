<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.cms.modules.population.mapper.MedicalMapper">

    <resultMap id="MedicalMap" type="com.example.cms.modules.population.entity.Medical">
        <id property="id" column="id"/>
        <result property="residentId" column="resident_id"/>
        <result property="residentName" column="resident_name"/>
        <result property="idCard" column="id_card"/>
        <result property="hospital" column="hospital"/>
        <result property="department" column="department"/>
        <result property="doctor" column="doctor"/>
        <result property="diagnosis" column="diagnosis"/>
        <result property="lastCheckupDate" column="last_checkup_date"/>
        <result property="insuranceType" column="insurance_type"/>
        <result property="notes" column="notes"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="createdBy" column="created_by"/>
    </resultMap>

    <select id="findAll" resultMap="MedicalMap">
        SELECT * FROM medical ORDER BY id ASC
    </select>
    
    <select id="findAllWithPagination" resultMap="MedicalMap">
        SELECT * FROM medical ORDER BY id ASC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="findById" resultMap="MedicalMap">
        SELECT * FROM medical WHERE id = #{id}
    </select>

    <insert id="insert" parameterType="com.example.cms.modules.population.entity.Medical">
        INSERT INTO medical(id, resident_id, resident_name, id_card, hospital, department, doctor, diagnosis, last_checkup_date, insurance_type, notes, create_time, update_time, created_by)
        VALUES(#{id}, #{residentId}, #{residentName}, #{idCard}, #{hospital}, #{department}, #{doctor}, #{diagnosis}, #{lastCheckupDate}, #{insuranceType}, #{notes}, #{createTime}, #{updateTime}, #{createdBy})
    </insert>

    <update id="update" parameterType="com.example.cms.modules.population.entity.Medical">
        UPDATE medical
        SET resident_id=#{residentId}, resident_name=#{residentName}, id_card=#{idCard}, hospital=#{hospital}, department=#{department}, doctor=#{doctor}, 
            diagnosis=#{diagnosis}, last_checkup_date=#{lastCheckupDate}, insurance_type=#{insuranceType}, notes=#{notes}, update_time=#{updateTime}
        WHERE id=#{id}
    </update>

    <delete id="deleteById">
        DELETE FROM medical WHERE id = #{id}
    </delete>

    <select id="findByResidentId" resultMap="MedicalMap">
        SELECT * FROM medical WHERE resident_id = #{residentId} ORDER BY id ASC
    </select>
    
    <select id="search" resultMap="MedicalMap">
        SELECT * FROM medical
        <where>
            <if test="residentName != null and residentName != ''">
                AND resident_name LIKE CONCAT('%', #{residentName}, '%')
            </if>
            <if test="hospitalName != null and hospitalName != ''">
                AND hospital LIKE CONCAT('%', #{hospitalName}, '%')
            </if>
        </where>
        ORDER BY id ASC
    </select>
    
    <select id="count" resultType="int">
        SELECT COUNT(*) FROM medical
    </select>
    
    <select id="findByCreatedBy" resultMap="MedicalMap">
        SELECT * FROM medical WHERE created_by = #{createdBy} ORDER BY id ASC
        <if test="size != null">
            LIMIT #{size} OFFSET #{offset}
        </if>
    </select>
    
    <select id="countByCreatedBy" resultType="int">
        SELECT COUNT(*) FROM medical WHERE created_by = #{createdBy}
    </select>
    
    <!-- 查询管理员和当前用户创建的医疗记录，支持分页 -->
    <select id="findByAdminOrCreatedBy" resultMap="MedicalMap">
        SELECT * FROM medical WHERE created_by = 1 OR created_by = #{createdBy} ORDER BY id ASC
        <if test="size != null">
            LIMIT #{size} OFFSET #{offset}
        </if>
    </select>
    
    <!-- 统计管理员和当前用户创建的医疗记录数量 -->
    <select id="countByAdminOrCreatedBy" resultType="int">
        SELECT COUNT(*) FROM medical WHERE created_by = 1 OR created_by = #{createdBy}
    </select>
    
    <!-- 获取医疗表中的全局最大ID -->
    <select id="getMaxId" resultType="long">
        SELECT COALESCE(MAX(id), 0) AS max_id FROM medical
    </select>
    
    <update id="reorderIds">
        UPDATE medical m1
        JOIN (
            SELECT id, ROW_NUMBER() OVER (ORDER BY id) AS new_id
            FROM medical
        ) m2 ON m1.id = m2.id
        SET m1.id = m2.new_id
    </update>

    <!-- 根据居民ID列表查询医疗记录，支持分页 -->
    <select id="findByResidentIds" resultMap="MedicalMap">
        SELECT * FROM medical
        WHERE resident_id IN
        <foreach collection="residentIds" item="residentId" open="(" separator="," close=")">
            #{residentId}
        </foreach>
        ORDER BY id ASC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 根据居民ID列表统计医疗记录数量 -->
    <select id="countByResidentIds" resultType="int">
        SELECT COUNT(*) FROM medical
        WHERE resident_id IN
        <foreach collection="residentIds" item="residentId" open="(" separator="," close=")">
            #{residentId}
        </foreach>
    </select>

</mapper>